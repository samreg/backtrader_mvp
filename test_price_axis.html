<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test - Axe des Prix</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #4dd0e1;
        }
        
        #mainChart {
            height: 500px;
            background: #1a1d29;
            border-radius: 8px;
            margin: 20px 0;
            position: relative;
        }
        
        #zonesCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        .status {
            background: #1a1d29;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .success {
            color: #26a69a;
        }
        
        .warning {
            color: #ff9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âœ… Test - Axe des Prix & Zones</h1>
        
        <div id="mainChart" style="position: relative;">
            <canvas id="zonesCanvas"></canvas>
        </div>
        
        <div class="status">
            <h3>VÃ©rifications :</h3>
            <ul>
                <li class="success">âœ“ Axe des prix visible Ã  droite</li>
                <li class="success">âœ“ Zone verte ne dÃ©borde PAS sur l'axe</li>
                <li class="success">âœ“ Zone rouge s'arrÃªte avant l'axe</li>
            </ul>
        </div>
    </div>
    
    <script>
        // DonnÃ©es de test
        const candlesData = [
            { time: 1704380400, open: 1.1000, high: 1.1050, low: 1.0990, close: 1.1020 },
            { time: 1704380700, open: 1.1020, high: 1.1080, low: 1.1010, close: 1.1070 },
            { time: 1704381000, open: 1.1070, high: 1.1100, low: 1.1060, close: 1.1090 },
            { time: 1704381300, open: 1.1090, high: 1.1120, low: 1.1080, close: 1.1110 },
            { time: 1704381600, open: 1.1110, high: 1.1150, low: 1.1100, close: 1.1130 },
            { time: 1704381900, open: 1.1130, high: 1.1160, low: 1.1120, close: 1.1140 },
            { time: 1704382200, open: 1.1140, high: 1.1170, low: 1.1130, close: 1.1150 },
            { time: 1704382500, open: 1.1150, high: 1.1180, low: 1.1140, close: 1.1160 },
            { time: 1704382800, open: 1.1160, high: 1.1190, low: 1.1150, close: 1.1170 },
            { time: 1704383100, open: 1.1170, high: 1.1200, low: 1.1160, close: 1.1180 }
        ];
        
        // Configuration CORRIGÃ‰E avec rightPriceScale
        const mainChart = LightweightCharts.createChart(document.getElementById('mainChart'), {
            layout: { background: { color: '#1a1d29' }, textColor: '#d1d4dc' },
            grid: { vertLines: { color: 'rgba(43, 43, 67, 0.2)' }, horzLines: { color: 'rgba(43, 43, 67, 0.2)' } },
            width: document.getElementById('mainChart').clientWidth,
            height: 500,
            rightPriceScale: {
                visible: true,
                borderVisible: true,
                scaleMargins: {
                    top: 0.1,
                    bottom: 0.1
                }
            },
            timeScale: { timeVisible: true, secondsVisible: false },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal }
        });
        
        const candlestickSeries = mainChart.addCandlestickSeries({
            upColor: '#26a69a',
            downColor: '#ef5350',
            borderVisible: false,
            wickUpColor: '#26a69a',
            wickDownColor: '#ef5350'
        });
        candlestickSeries.setData(candlesData);
        
        // Zones de test
        const zonesData = [
            {
                id: 'zone_1',
                entry_index: 2,
                exit_index: null,  // Zone active
                price_low: 1.1050,
                price_high: 1.1070,
                color: '#26a69a',
                alpha: 0.25,
                direction: 'bullish',
                state: 'active'
            },
            {
                id: 'zone_2',
                entry_index: 5,
                exit_index: 8,
                price_low: 1.1130,
                price_high: 1.1160,
                color: '#8B0000',
                alpha: 0.25,
                direction: 'bearish',
                state: 'active'
            }
        ];
        
        // Canvas setup
        const canvas = document.getElementById('zonesCanvas');
        const ctx = canvas.getContext('2d');
        
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        
        function drawZones() {
            const chartElement = document.getElementById('mainChart');
            canvas.width = chartElement.clientWidth;
            canvas.height = 500;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const timeScale = mainChart.timeScale();
            
            // CORRECTION: Limite Ã  la zone du chart (sans l'axe des prix)
            const priceScaleWidth = 60;
            const maxX = canvas.width - priceScaleWidth;
            
            console.log(`ðŸ“ Canvas: ${canvas.width}px, Chart area: 0-${maxX}px, Price scale: ${maxX}-${canvas.width}px`);
            
            zonesData.forEach((zone) => {
                const x1 = timeScale.timeToCoordinate(candlesData[zone.entry_index].time);
                if (x1 === null) return;
                
                let x2;
                if (zone.exit_index !== null) {
                    x2 = timeScale.timeToCoordinate(candlesData[zone.exit_index].time);
                    if (x2 === null) x2 = maxX;
                } else {
                    // Zone active - s'arrÃªte AVANT l'axe des prix
                    x2 = maxX;
                }
                
                // Clamp x2
                x2 = Math.min(x2, maxX);
                
                const y1 = candlestickSeries.priceToCoordinate(zone.price_high);
                const y2 = candlestickSeries.priceToCoordinate(zone.price_low);
                
                if (y1 === null || y2 === null) return;
                
                const left = Math.min(x1, x2);
                const top = Math.min(y1, y2);
                const width = Math.abs(x2 - x1);
                const height = Math.abs(y2 - y1);
                
                console.log(`Zone ${zone.id}: x=${left} to ${left + width} (maxX=${maxX})`);
                
                // Draw
                const fillColor = hexToRgba(zone.color, zone.alpha);
                ctx.fillStyle = fillColor;
                ctx.fillRect(left, top, width, height);
                
                ctx.strokeStyle = zone.color;
                ctx.lineWidth = 1;
                ctx.strokeRect(left, top, width, height);
                
                // Label
                ctx.fillStyle = zone.color;
                ctx.font = '12px Arial';
                ctx.fillText(zone.direction.toUpperCase(), left + 5, top + 15);
            });
        }
        
        // Initial draw
        setTimeout(() => {
            drawZones();
        }, 100);
        
        // Redraw on zoom/pan
        mainChart.timeScale().subscribeVisibleLogicalRangeChange(() => {
            drawZones();
        });
        
        // Redraw on resize
        window.addEventListener('resize', () => {
            mainChart.applyOptions({ width: document.getElementById('mainChart').clientWidth });
            drawZones();
        });
        
        mainChart.timeScale().fitContent();
    </script>
</body>
</html>
